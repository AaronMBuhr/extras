{
  "first_match_only": true,
  "rewrite_rules": [
    {
      "comment": [
        "Name: WatchGoard Firebox",
        "Description: Parses WatchGuards's 'LEEF' formatted logs",
        "IMPORTANT! This rule must be fired AFTER 000-IBM-LEEF.json in the logzilla rules.d directory",
        "Reference URL: https://www.watchguard.com/help/docs/fireware/12/en-US/Content/en-US/logging/send_logs_to_syslog_server_wsm.html?TocPath=Monitor%20Network%20Traffic%7CSet%20Up%20Logging%20%26%20Reporting%20for%20Your%20Network%7CDefine%20Where%20the%20Firebox%20Sends%20Log%20Messages%20",
        "Sample Log: 1.0|WatchGuard|XTM|12.1.1.B558423|2CFF0000|policy=HTTPS-proxy-00    disp=Allow    in_if=28-VLAN28    out_if=0-External    proto=tcp    src=    srcPort=39992    dst=    dstPort=443    proxy_act=Default-HTTPS-Client    tls_profile=TLS-Client-HTTPS.Standard    tls_version=TLS_V12    sni=    cn=    cert_issuer=CN=COMODO ECC Domain Validation Secure Server CA 2,O=COMODO CA Limited,L=Salford,ST=Greater Manchester,C=GB    cert_subject=CN=,OU=PositiveSSL Multi-Domain,OU=Domain Control Validated    action=allow    app_id=94    app_cat_id=19    app_name=HTTP Protocol over TLS SSL    app_cat_name=Network Protocols(3)    sent_bytes=10139    rcvd_bytes=10139    msg=HTTPS Request ",
        "Sample Log (after 000-IBM-LEEF.json has parsed it): leef_version=1.0 leef_vendor_name=WatchGuard leef_product_name=XTM leef_product_version=12.1.1.B558423 leef_event_id=2CFF0000 policy=HTTPS-proxy-00    disp=Allow    in_if=28-VLAN28    out_if=0-External    proto=tcp    src=    srcPort=39992    dst=    dstPort=443    proxy_act=Default-HTTPS-Client    tls_profile=TLS-Client-HTTPS.Standard    tls_version=TLS_V12    sni=    cn=    cert_issuer=CN=COMODO ECC Domain Validation Secure Server CA 2,O=COMODO CA Limited,L=Salford,ST=Greater Manchester,C=GB    cert_subject=CN=,OU=PositiveSSL Multi-Domain,OU=Domain Control Validated    action=allow    app_id=94    app_cat_id=19    app_name=HTTP Protocol over TLS SSL    app_cat_name=Network Protocols(3)    sent_bytes=10139    rcvd_bytes=10139    msg=HTTPS Request ",
        "Sample 2: leef_version=1.0 leef_vendor_name=WatchGuard leef_product_name=XTM leef_product_version=12.1.1.B558423 leef_event_id=2CFF0001 policy=HTTPS-proxy-00    disp=Allow    in_if=28-VLAN28    out_if=0-External    proto=tcp    src=10.168.28.18    srcPort=42228    dst=14.17.16.108    dstPort=443    proxy_act=Default-HTTPS-Client    service=Default-WebBlocker    cats=Information Technology    dstname=foo.com    msg=ProxyAllow: HTTPS Request categories",
        "Sample 3: leef_version=1.0 leef_vendor_name=WatchGuard leef_product_name=XTM leef_product_version=12.1.1.B558423 leef_event_id=30000149 policy=DNS-00    disp=Allow    in_if=28-VLAN28    out_if=0-External    ip_len=61    ip_TTL=63    proto=udp    src=10.168.28.138    srcPort=37773    srcPostNAT=172.168.0.2    srcPostNATPORT=37907    dst=8.8.8.8    dstPort=53    app=DNS    app_cat=Network protocols    app_behavior=access    msg=Application identified",
        "Sample 4: policy=DNS-00 disp=Allow    in_if=28-VLAN28   out_if=0-External ip_len=72 ip_TTL=63 proto=udp src=10.168.28.112    srcPort=58668 srcPostNAT=172.168.0.2 srcPostNATPORT=58044 dst=8.8.8.8   dstPort=53    app=DNS app_cat=Network protocols   app_behavior=access   msg=Application identified",
        "Category: Security"
      ],
      "match": {
        "field": "program",
        "value": "WatchGuard"
      },
      "kv": {
        "delimiter": "",
        "separator": "="
      },
      "tag": {
        "ut_src_ip": "${src}",
        "ut_dst_ip": "${dst}",
        "ut_src_port": "${srcPort}",
        "ut_dst_port": "${dstPort}",
        "ut_watchguard_policy": "${policy}",
        "ut_watchguard_disposition": "${disp}",
        "ut_watchguard_rule_name": "${out_if}",
        "ut_watchguard_protocol": "${proto}",
        "ut_watchguard_proxy_act": "${proxy_act}",
        "ut_watchguard_action": "${action}",
        "ut_watchguard_app_id": "${app_id}",
        "ut_watchguard_app_cat_id": "${app_cat_id}",
        "ut_watchguard_app_name": "${app_name}",
        "ut_watchguard_app_cat_name": "${app_cat_name}",
        "ut_watchguard_srcPostNAT": "${srcPostNAT}",
        "ut_watchguard_srcPostNATPORT": "${srcPostNATPORT}",
        "ut_watchguard_app_behavior": "${app_behavior}",
        "ut_watchguard_msg": "${msg}"
      }
    },
    {
      "comment": "Track Denied Sites",
      "match": [
        {
          "field": "program",
          "value": "WatchGuard"
        },
        {
          "field": "message",
          "op": "=~",
          "value": "Deny.+cats=\\S+ .+dstname"
        }
      ],
      "tag": {
        "ut_watchguard_denied_urls": "${dstname}",
        "ut_watchguard_denied_urls_categories": "${cats}",
        "ut_watchguard_denied_urls_src_dst_pairs": "${cats}: ${src} -> ${dst}:${dstPort}"
      }
    },
    {
      "comment": "Track Denied Applications",
      "match": [
        {
          "field": "program",
          "value": "WatchGuard"
        },
        {
          "field": "message",
          "op": "=~",
          "value": "disp.?=\"?Deny.+app=\\S+ .+app_cat=\\S+ "
        }
      ],
      "tag": {
        "ut_watchguard_denied_apps": "${app}",
        "ut_watchguard_denied_apps_categories": "${app_cat}",
        "ut_watchguard_denied_appname_src_dst_port": "${app}: ${src} -> ${dst}:${dstPort}"
      }
    },
    {
      "comment": "Track Allowed Applications",
      "match": [
        {
          "field": "program",
          "value": "WatchGuard"
        },
        {
          "field": "message",
          "op": "=~",
          "value": "disp.?=\"?Allow.+app=\\S+ .+app_cat=\\S+ "
        }
      ],
      "tag": {
        "ut_watchguard_allowed_apps": "${app}",
        "ut_watchguard_allowed_apps_categories": "${app_cat}",
        "ut_watchguard_allowed_appname_src_dst_port": "${app}: ${src} -> ${dst}:${dstPort}"
      }
    },
    {
      "comment": "Track Torrent Users",
      "match": [
        {
          "field": "program",
          "value": "WatchGuard"
        },
        {
          "field": "message",
          "op": "=~",
          "value": "dstPort=\"?688\\d+"
        }
      ],
      "tag": {
        "ut_watchguard_torrent_tracking": "${disp} ${src} -> ${dst}:${dstPort}"
      }
    },
    {
      "comment": "If we have both src and dst, create a new pair",
      "match": [
        {
          "field": "program",
          "value": "WatchGuard"
        },
        {
          "field": "message",
          "op": "=~",
          "value": "src=\\S+ .+dst\"?=\\S+ "
        }
      ],
      "tag": {
        "ut_watchguard_src_dst_pairs": "${src}->${dst}"
      }
    }
  ]
}
